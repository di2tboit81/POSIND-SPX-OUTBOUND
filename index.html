<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R7 ( BUKTI SERAH KIRIM )POSIND - SPX</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>

/* SEMBUNYIKAN DI LAYAR */
.ttd-card{
    display: none;
}

/* TAMPIL SAAT PRINT */
@media print {
    .ttd-card{
        display: block !important;
    }
}

:root{
--navy:#0F172A;
--navy2:#1E293B;
--orange:#FF6A00;
--bg:#F1F5F9;
}
*{box-sizing:border-box;}
body{
margin:0;
font-family:'Poppins',sans-serif;
background:var(--bg);
}
.header{
background:linear-gradient(135deg,var(--navy),var(--navy2));
color:white;
padding:15px;
}
.header-top{
display:flex;
justify-content:space-between;
align-items:center;
}
.header img{
height:45px;
}
.header-title{
text-align:center;
font-weight:700;
margin-top:10px;
font-size:16px;
}
.container{
padding:15px;
max-width:900px;
margin:auto;
}
.card{
background:white;
padding:15px;
border-radius:16px;
box-shadow:0 5px 15px rgba(0,0,0,0.08);
margin-bottom:15px;
}
label{font-weight:600;font-size:13px;}
input{
width:100%;
padding:12px;
margin-top:5px;
margin-bottom:12px;
border-radius:12px;
border:1px solid #ddd;
}
button{
width:100%;
padding:14px;
border:none;
border-radius:12px;
font-weight:600;
margin-top:8px;
cursor:pointer;
}
.btn-primary{background:var(--navy);color:white;}
.btn-orange{background:var(--orange);color:white;}
.btn-danger{background:#e53935;color:white;}
.btn-success{background:#2ecc71;color:white;}
.btn-excel{background:#f39c12;color:white;}
table{
width:100%;
border-collapse:collapse;
font-size:13px;
}
th{
background:var(--navy);
color:white;
padding:10px;
}
td{
padding:8px;
border-bottom:1px solid #eee;
text-align:center;
}
.total-box{
text-align:center;
font-weight:700;
margin-top:10px;
}
#notif{
text-align:center;
font-weight:600;
margin-top:10px;
}
.success{color:green;}
.error{color:red;}
canvas{
width:100%;
max-width:300px;
border:1px solid #ddd;
border-radius:10px;
}
</style>

<!-- FIREBASE REALTIME SYNC -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDxoHPHq8MzVSdK9VFlU5VpIcLjb1RrQGI",
  authDomain: "db-outbound.firebaseapp.com",
  databaseURL: "https://db-outbound-default-rtdb.firebaseio.com",
  projectId: "db-outbound",
  storageBucket: "db-outbound.firebasestorage.app",
  messagingSenderId: "1096892913563",
  appId: "1:1096892913563:web:b4fd1fd46d5d733960733e",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>


</head>

<body>

<div class="header">
<div class="header-top">
</div>
<div class="header-title">
BUKTI SERAH KIRIM ( R7 )<br>
POSIND ‚ûú SPX
</div>
</div>

<div class="container">

<div class="card">

<label>Tanggal</label>
<input type="text" id="tanggal" readonly>

<label>Nama Petugas R7</label>
<input type="text" id="petugas">

<label>Nama Driver</label>
<input type="text" id="driver">

<label>No Polisi</label>
<input type="text" id="nopol">

<label>Angkutan</label>
<input type="text" id="angkutan">

<label>Mode</label>
<input type="text" id="mode">

</div>

<div class="card">
<label>Input No Kantong</label>
<input type="text" id="manualBarcode" placeholder="Scan / Ketik barcode lalu Enter">
<button class="btn-orange" onclick="tambahManual()">Tambah No Kantong</button>
</div>

<div class="card">

<!-- COUNTER SCAN -->
<div id="scanCounter" 
     style="text-align:center;
            font-size:16px;
            font-weight:700;
            color:#FF6A00;
            margin-bottom:8px;">
Total Scan Berhasil : 0  
</div>

<div id="reader"></div>

<div id="notif"></div>

<div id="lastScan" 
     style="text-align:center;
            font-weight:bold;
            margin-top:8px;
            color:#0F172A;">
</div>

</div>

<div class="card">
<table id="tabelData">
<tr>
<th>No</th>
<th>Kantong</th>
<th>Berat (KG)</th>
<th>Hapus</th>
</tr>
</table>
<div class="total-box">
Total Berat: <span id="totalBerat">0</span> KG
</div>
</div>

<div class="card">
<button class="btn-danger" onclick="hapusSemua()">Hapus Semua</button>
<button class="btn-success" onclick="printPDF()">Print / Save PDF</button>
<button class="btn-excel" onclick="exportExcel()">Export Excel</button>
</div>

<div class="card ttd-card">
<h4>Tanda Tangan Penerima</h4>
<canvas id="signature" width="300" height="150"></canvas>
<button class="btn-primary" onclick="clearSignature()">Clear Tanda Tangan</button>
</div>

</div>

<script>
// ===== TAMBAHAN UNTUK TAMPILKAN DATA TERAKHIR (SCAN & MANUAL) =====
(function(){

    // Simpan fungsi asli
    const originalProses = prosesBarcode;

    // Override tanpa mengubah isi lama
    prosesBarcode = function(barcode){

        // Panggil fungsi lama dulu
        originalProses(barcode);

        // Jika berhasil masuk ke array, tampilkan sebagai data terakhir
        if(scannedBarcodes.includes(barcode)){
            document.getElementById("lastScan").innerHTML =
                "‚úÖ Data Terakhir : <span style='color:#FF6A00'>" + barcode + "</span>";
        }

    };

})();

function updateScanCounter(){
document.getElementById("scanCounter").innerText =
"Sukses Scan Kantong Ke : " + scannedBarcodes.length;
}
function updateTotalBerat(){
let total = scannedData.reduce((sum,item)=> sum + item.berat,0);

document.getElementById("totalBerat").innerText =
total.toLocaleString("id-ID",{
minimumFractionDigits:2,
maximumFractionDigits:2
});
}

let scannedBarcodes=[];
let scannedData=[]; // simpan barcode + berat

// ===== AUTO SAVE LOCAL STORAGE =====
function simpanLocal(){
localStorage.setItem("r7_scannedBarcodes", JSON.stringify(scannedBarcodes));
localStorage.setItem("r7_scannedData", JSON.stringify(scannedData));
}

function loadLocal(){

let savedBarcodes = localStorage.getItem("r7_scannedBarcodes");
let savedData = localStorage.getItem("r7_scannedData");

if(savedBarcodes && savedData){

scannedBarcodes = JSON.parse(savedBarcodes);
scannedData = JSON.parse(savedData);

// Render ulang tabel
scannedData.forEach((item,index)=>{
tambahData(item.barcode,item.berat);
});

updateScanCounter();
updateTotalBerat();
}
}

function updateTanggalJam(){
    let now = new Date();

    let options = { 
        day: '2-digit', 
        month: 'long', 
        year: 'numeric' 
    };

    let tanggal = now.toLocaleDateString("id-ID", options);
    let jam = now.toLocaleTimeString("id-ID");

    document.getElementById("tanggal").value = tanggal + " - " + jam;
}

setInterval(updateTanggalJam,1000);
updateTanggalJam();

function beep(url){ new Audio(url).play(); }

function showNotif(text,type){
let n=document.getElementById("notif");
n.innerText=text;
n.className=type;
setTimeout(()=>{n.innerText="";},2000);
}

function prosesBarcode(barcode){

if(scannedBarcodes.includes(barcode)){
beep("https://actions.google.com/sounds/v1/alarms/winding_alarm_clock.ogg");
showNotif("‚ùå Kantong sudah ada!","error");
return;
}

let petugas=document.getElementById("petugas").value;
let driver=document.getElementById("driver").value;
let nopol=document.getElementById("nopol").value;
let angkutan=document.getElementById("angkutan").value;
let mode=document.getElementById("mode").value;

if(!petugas||!driver||!nopol||!angkutan||!mode){
alert("Oiii KIMBEK...Lengkapi Data Driver Dulu!");
return;
}

// üîä BEEP SAAT BERHASIL BACA
beep("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

// INPUT BERAT
let berat = prompt("Masukkan Berat (KG) untuk kantong ini:");

if(berat===null || berat.trim()==="" || isNaN(berat)){
showNotif("‚ùå Berat tidak valid!","error");
return;
}

berat = parseFloat(berat);

// Simpan data
scannedBarcodes.push(barcode);
scannedData.push({barcode:barcode, berat:berat});
simpanLocal();

// Tambah ke tabel
tambahData(barcode,berat);

// Update counter
updateScanCounter();
updateTotalBerat();

// Reset input manual & fokus kembali
let input = document.getElementById("manualBarcode");
input.value="";
input.focus();

showNotif("‚úÖ Berhasil ditambahkan","success");
}

function onScanSuccess(decodedText){

prosesBarcode(decodedText);

// Pause sebentar agar tidak double scan
scanner.clear();

setTimeout(()=>{
    scanner.render(onScanSuccess);

    // üî¶ Nyalakan ulang torch setelah render ulang
    setTimeout(()=>{
        aktifkanTorchUlang();
    },800);

},1000);
}

let scanner = new Html5QrcodeScanner("reader",{fps:10,qrbox:250});
scanner.render(onScanSuccess);

// ===== AUTO FLASH (TORCH) SAAT SCAN DI HP =====
let currentCameraTrack = null;
async function aktifkanTorchUlang(){
    try{
        const video = document.querySelector("#reader video");
        if(video && video.srcObject){
            const stream = video.srcObject;
            const track = stream.getVideoTracks()[0];
            currentCameraTrack = track;

            const capabilities = track.getCapabilities();

            if(capabilities.torch){
                await track.applyConstraints({
                    advanced: [{ torch: true }]
                });
                console.log("Flash ON üî¶ (ulang)");
            }
        }
    }catch(err){
        console.log("Torch gagal diaktifkan ulang");
    }
}

// Ambil kamera setelah scanner aktif
setTimeout(async () => {
    try {
        const video = document.querySelector("#reader video");
        if (video && video.srcObject) {
            const stream = video.srcObject;
            const track = stream.getVideoTracks()[0];
            currentCameraTrack = track;

            const capabilities = track.getCapabilities();

            if (capabilities.torch) {
                await track.applyConstraints({
                    advanced: [{ torch: true }]
                });
                console.log("Flash ON üî¶");
            }
        }
    } catch (err) {
        console.log("Flash tidak didukung di perangkat ini");
    }
}, 1500);


function tambahManual(){
let input=document.getElementById("manualBarcode");
let barcode=input.value.trim();
if(barcode===""){
showNotif("‚ùå Data Kantong Kosong!","error");
return;
}
prosesBarcode(barcode);
input.value="";
}

document.getElementById("manualBarcode")
.addEventListener("keypress",function(e){
if(e.key==="Enter") tambahManual();
});

function tambahData(barcode,berat){
let table=document.getElementById("tabelData");
let row=table.insertRow();
row.insertCell(0).innerHTML = table.rows.length - 1;
row.insertCell(1).innerHTML=barcode;
row.insertCell(2).innerHTML=berat.toFixed(2);
row.insertCell(3).innerHTML=
`<button class="btn-danger" onclick="hapusBaris(this,'${barcode}')">X</button>`;

}

function hapusBaris(btn,barcode){

    // üî• HAPUS DARI FIREBASE (INI YANG KURANG)
    roomDataRef.child(barcode).remove();

    // Hapus dari tabel
    btn.parentNode.parentNode.remove();

    // Hapus dari array lokal
    scannedBarcodes = scannedBarcodes.filter(b=>b!==barcode);
    scannedData = scannedData.filter(d=>d.barcode!==barcode);

    simpanLocal();

    updateNomor();
    updateScanCounter();
    updateTotalBerat();
}

function updateNomor(){
let rows=document.querySelectorAll("#tabelData tr");
for(let i=1;i<rows.length;i++){
rows[i].cells[0].innerText=i;
}

}

function kirimFormKeFirebase(){

    const formData = {
        petugas: document.getElementById("petugas").value,
        driver: document.getElementById("driver").value,
        nopol: document.getElementById("nopol").value,
        angkutan: document.getElementById("angkutan").value,
        mode: document.getElementById("mode").value
    };

    roomRef.child("FORM_R7").set(formData);
}

["petugas","driver","nopol","angkutan","mode"].forEach(id=>{
    document.getElementById(id).addEventListener("input", ()=>{
        simpanFormR7();
        kirimFormKeFirebase();
    });
});

function hapusSemua(){

roomRef.remove(); // Hapus semua data di room Firebase

scannedData = [];
scannedBarcodes = [];

document.getElementById("tabelData").innerHTML =
`<tr>
<th>No</th>
<th>Kantong</th>
<th>Berat (KG)</th>
<th>Hapus</th>
</tr>`;

updateScanCounter();
updateTotalBerat();

}
const canvas=document.getElementById("signature");
const ctx=canvas.getContext("2d");
let drawing=false;

canvas.onmousedown=()=>drawing=true;
canvas.onmouseup=()=>drawing=false;
canvas.onmousemove=(e)=>{
if(!drawing) return;
ctx.lineWidth=2;
ctx.lineCap="round";
ctx.strokeStyle="black";
ctx.lineTo(e.offsetX,e.offsetY);
ctx.stroke();
ctx.beginPath();
ctx.moveTo(e.offsetX,e.offsetY);
localStorage.removeItem("r7_scannedBarcodes");
localStorage.removeItem("r7_scannedData");
};

function clearSignature(){
ctx.clearRect(0,0,canvas.width,canvas.height);
}

function generateNomorDokumen(){
let d=new Date();
return "STK-SPX-POSIND/"+d.getFullYear()+
("0"+(d.getMonth()+1)).slice(-2)+
("0"+d.getDate()).slice(-2)+
"/"+Math.floor(Math.random()*1000);
}

/* PRINT PDF SUPER PADAT PREMIUM - FONT PALING BESAR TANPA TAMBAH HALAMAN */
function printPDF(){

if(scannedBarcodes.length===0){
alert("Belum Ada Data Kantong KIMBEK !");
return;
}

let tanggal=document.getElementById("tanggal").value;
let petugas=document.getElementById("petugas").value;
let driver=document.getElementById("driver").value;
let nopol=document.getElementById("nopol").value;
let angkutan=document.getElementById("angkutan").value;
let mode=document.getElementById("mode").value;
let nomor=generateNomorDokumen();
let signatureImage=canvas.toDataURL("image/png");

let qrData = `
R7 ( BUKTI SERAH KIRIM ) POSIND ‚ûú SPX

Nomor Dokumen : ${nomor}
Tanggal       : ${tanggal}
Nama Driver   : ${driver}
No Polisi     : ${nopol}
Angkutan      : ${angkutan}
Mode          : ${mode}
Total Kantong : ${scannedBarcodes.length}
`;
QRCode.toDataURL(qrData,function(err,url){

let now = new Date();

let fileTime =
("0"+now.getDate()).slice(-2) +
("0"+(now.getMonth()+1)).slice(-2) +
now.getFullYear() + "_" +
("0"+now.getHours()).slice(-2) +
("0"+now.getMinutes()).slice(-2) +
("0"+now.getSeconds()).slice(-2);

let win=window.open("","","width=900,height=1200");

win.document.write(`
<html>
<head>
<title>Serah_Terima_R7_${fileTime}</title>
<style>
@page { 
size:A4 portrait; 
margin:0mm; 
}

body{
font-family:Arial;
margin:0;
}

.page{
page-break-after:always;
}
.page:last-child{
page-break-after:auto;
}

.judul{
text-align:center;
font-size:16px;
font-weight:bold;
margin-top:5px;
margin-bottom:5px;
}

.info{
margin-top:4px;
font-size:11px;
line-height:1.3;
}

.flex-table{
display:flex;
gap:5px;
margin-top:5px;
}

table{
width:50%;
border-collapse:collapse;
font-size:11px;
}

th{
background:#000;
color:#fff;
font-size:11px;
}

th, td{
border:1px solid black;
padding:2px;
text-align:center;
}

.footer{
margin-top:10px;
display:flex;
justify-content:space-between;
align-items:flex-end;
}

.box-ttd{
width:30%;
text-align:center;
font-size:11px;
}
</style>
</head>
<body>
`);

let perColumn = 40;
let perPage = 80;
let totalPages = Math.ceil(scannedBarcodes.length / perPage);

for(let p=0; p<totalPages; p++){

let start = p * perPage;
let end = start + perPage;

let pageData = scannedBarcodes.slice(start, end);

let leftData = pageData.slice(0, perColumn);
let rightData = pageData.slice(perColumn, perPage);

let leftTable = `
<table>
<tr>
<th style="width:10%">No</th>
<th style="width:40%">NO KANTONG</th>
<th style="width:25%">PRODUK</th>
<th style="width:25%">BERAT (KG)</th>
</tr>
`;

leftData.forEach((barcode,index)=>{

let data = scannedData.find(d => d.barcode === barcode);

leftTable += `
<tr>
<td>${start + index + 1}</td>
<td>${barcode}</td>
<td>ECO</td>
<td>${data ? data.berat.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2}) : "0.00"}</td>
</tr>`;
});

// Isi kosong sampai 40 baris
for(let i=leftData.length;i<perColumn;i++){
leftTable += `<tr><td>&nbsp;</td><td></td><td></td><td></td></tr>`;
}

leftTable += `</table>`;


let rightTable = `
<table>
<tr>
<th style="width:10%">No</th>
<th style="width:40%">NO KANTONG</th>
<th style="width:25%">PRODUK</th>
<th style="width:25%">BERAT (KG)</th>
</tr>
`;

rightData.forEach((barcode,index)=>{

let data = scannedData.find(d => d.barcode === barcode);

rightTable += `
<tr>
<td>${start + perColumn + index + 1}</td>
<td>${barcode}</td>
<td>ECO</td>
<td>${data ? data.berat.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2}) : "0.00"}</td>
</tr>`;
});

// Isi kosong sampai 40 baris
for(let i=rightData.length;i<perColumn;i++){
rightTable += `<tr><td>&nbsp;</td><td></td><td></td><td></td></tr>`;
}

rightTable += `</table>`;


win.document.write(`
<div class="page">

<div class="judul">
DAFTAR LAMPIRAN R7
</div>
<div class="judul">
Dari KCU BATAM 29400 Tujuan PEKANBARU
</div>

${p===0 ? `
<div class="info" style="font-size:12px;margin-top:5px;">

<div style="display:flex;">
<div style="width:130px;"><strong>Nama Driver</strong></div>
<div style="width:15px;">:</div>
<div>${driver}</div>
</div>

<div style="display:flex;">
<div style="width:130px;"><strong>No Polisi</strong></div>
<div style="width:15px;">:</div>
<div>${nopol}</div>
</div>

<div style="display:flex;">
<div style="width:130px;"><strong>Angkutan</strong></div>
<div style="width:15px;">:</div>
<div>${angkutan}</div>
</div>

<div style="display:flex;">
<div style="width:130px;"><strong>Mode</strong></div>
<div style="width:15px;">:</div>
<div>${mode}</div>
</div>

<div style="display:flex;">
<div style="width:130px;"><strong>Tanggal</strong></div>
<div style="width:15px;">:</div>
<div>${tanggal}</div>
</div>

</div>
` : ``}

<div class="flex-table">
${leftTable}
${rightTable}
</div>

${p === totalPages-1 ? `
<div style="margin-top:15px;width:100%;">
<table style="width:100%;border-collapse:collapse;font-size:14px;">
<tr>
<th style="border:1px solid black;">TOTAL KANTONG</th>
<th style="border:1px solid black;">PRODUK</th>
<th style="border:1px solid black;">TOTAL BERAT (KG)</th>
</tr>
<tr>
<td style="border:1px solid black;text-align:center;font-weight:900;color:#000;">
${scannedBarcodes.length.toLocaleString("id-ID")}
</td>
<td style="border:1px solid black;text-align:center;font-weight:bold;">
E-COMMERCE
</td>
<td style="border:1px solid black;text-align:center;font-weight:900;color:#000;">
${scannedData
    .reduce((s,d)=>s+d.berat,0)
    .toLocaleString("id-ID",{
        minimumFractionDigits:2,
        maximumFractionDigits:2
    })}
</td>
</tr>
</table>
</div>

<div class="footer">
<div class="box-ttd">
KANTOR ASAL<br>
<img src="${signatureImage}" width="110"><br><br>
${petugas}
</div>

<div class="box-ttd">
ANGKUTAN<br><br><br><br><br>
<br><br>
</div>

<div class="box-ttd">
KANTOR TUJUAN<br><br><br><br><br>
<br><br>
</div>

<div class="box-ttd">
QR<br>
<img src="${url}" width="95">
</div>
</div>
` : ``}

</div>
`);
}

win.document.write(`</body></html>`);
win.document.close();
win.print();

});
}

function exportExcel(){

if(scannedBarcodes.length===0){
alert("Belum Ada Data Kantong KIMBEK !");
return;
}

let tanggal=document.getElementById("tanggal").value;
let petugas=document.getElementById("petugas").value;
let driver=document.getElementById("driver").value;
let nopol=document.getElementById("nopol").value;
let angkutan=document.getElementById("angkutan").value;
let mode=document.getElementById("mode").value;

let wb = XLSX.utils.book_new();

let perColumn = 40;
let perPage = 80;
let totalPages = Math.ceil(scannedBarcodes.length / perPage);

for(let p=0; p<totalPages; p++){

let ws = {};
let merges = [];
let row = 1;

function setCell(r,c,value,bold=false,center=false){
ws[XLSX.utils.encode_cell({r:r-1,c:c-1})] = {
v:value,
t:"s",
s:{
font:{ bold:bold },
alignment:{ horizontal:center?"center":"left", vertical:"center" },
border:{
top:{style:"thin"},
bottom:{style:"thin"},
left:{style:"thin"},
right:{style:"thin"}
}
}
};
}

// ================= JUDUL =================
setCell(row,1,"DAFTAR LAMPIRAN R7",true,true);
merges.push({s:{r:row-1,c:0},e:{r:row-1,c:7}});
row++;

setCell(row,1,"Dari KCU BATAM 29400 Tujuan PEKANBARU",true,true);
merges.push({s:{r:row-1,c:0},e:{r:row-1,c:7}});
row+=2;


// ================= INFO HALAMAN PERTAMA =================
if(p===0){

const infoData = [
["Nama Driver",driver],
["No Polisi",nopol],
["Angkutan",angkutan],
["Mode",mode],
["Tanggal",tanggal]
];

infoData.forEach(i=>{
setCell(row,1,i[0],true);
setCell(row,2,":");
setCell(row,3,i[1]);
row++;
});

row+=1;
}


// ================= HEADER =================
const headers = ["No","NO KANTONG","PRODUK","BERAT (KG)"];

headers.forEach((h,i)=> setCell(row,1+i,h,true,true));
headers.forEach((h,i)=> setCell(row,5+i,h,true,true));
row++;

let start = p*perPage;
let end = start+perPage;
let pageData = scannedBarcodes.slice(start,end);

let leftData = pageData.slice(0,perColumn);
let rightData = pageData.slice(perColumn,perPage);

for(let i=0;i<perColumn;i++){

// LEFT SIDE
if(leftData[i]){
let data = scannedData.find(d=>d.barcode===leftData[i]);
setCell(row,1,String(start+i+1),false,true);
setCell(row,2,leftData[i],false,true);
setCell(row,3,"ECO",false,true); // <<< FIX PRODUK
setCell(row,4,
data?data.berat.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00",
false,true);
}else{
for(let c=1;c<=4;c++) setCell(row,c,"",false,true);
}

// RIGHT SIDE
if(rightData[i]){
let data = scannedData.find(d=>d.barcode===rightData[i]);
setCell(row,5,String(start+perColumn+i+1),false,true);
setCell(row,6,rightData[i],false,true);
setCell(row,7,"ECO",false,true); // <<< FIX PRODUK
setCell(row,8,
data?data.berat.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00",
false,true);
}else{
for(let c=5;c<=8;c++) setCell(row,c,"",false,true);
}

row++;
}


// ================= TOTAL DI HALAMAN TERAKHIR =================
if(p===totalPages-1){

row+=2;

let totalBerat = scannedData.reduce((s,d)=>s+d.berat,0);

// ===== HEADER TOTAL (SEPERTI PDF) =====
setCell(row,1,"TOTAL KANTONG",true,true);
setCell(row,3,"PRODUK",true,true);
setCell(row,5,"TOTAL BERAT (KG)",true,true);

row++;

// ===== NILAI DI BAWAHNYA (VERTICAL) =====
setCell(row,1,scannedBarcodes.length.toLocaleString("id-ID"),true,true);
setCell(row,3,"E-COMMERCE",true,true);
setCell(row,5,
totalBerat.toLocaleString("id-ID",{
minimumFractionDigits:2,
maximumFractionDigits:2
}),
true,true
);

row+=3;


// ===== TANDA TANGAN =====
setCell(row,1,"KANTOR ASAL",true,true);
setCell(row,3,"ANGKUTAN",true,true);
setCell(row,5,"KANTOR TUJUAN",true,true);
setCell(row,7,"QR",true,true);

row+=4;

setCell(row,1,petugas,false,true);
setCell(row,3,"",false,true);
setCell(row,5,"",false,true);
setCell(row,7,"Lihat QR di PDF",false,true);

}
ws["!ref"] = "A1:H"+row;
ws["!merges"] = merges;

ws["!cols"] = [
{wch:6},{wch:22},{wch:10},{wch:14},
{wch:6},{wch:22},{wch:10},{wch:14}
];

XLSX.utils.book_append_sheet(wb, ws, "Halaman_"+(p+1));

}

let now = new Date();

let fileTime =
("0"+now.getDate()).slice(-2) +
("0"+(now.getMonth()+1)).slice(-2) +
now.getFullYear() + "_" +
("0"+now.getHours()).slice(-2) +
("0"+now.getMinutes()).slice(-2) +
("0"+now.getSeconds()).slice(-2);

XLSX.writeFile(wb,"Serah_Terima_R7_" + fileTime + ".xlsx");
}

// LOAD DATA SAAT PAGE DIBUKA
window.onload = function(){
loadLocal();
};

// =============================
// AUTO SAVE FORM R7 (TIDAK HILANG SAAT RELOAD)
// =============================

// Simpan data form
function simpanFormR7(){
    const formData = {
        tanggal: document.getElementById("tanggal").value,
        petugas: document.getElementById("petugas").value,
        driver: document.getElementById("driver").value,
        nopol: document.getElementById("nopol").value,
        angkutan: document.getElementById("angkutan").value,
        mode: document.getElementById("mode").value
    };

    localStorage.setItem("r7_formData", JSON.stringify(formData));
}

// Load kembali data form
function loadFormR7(){
    const saved = localStorage.getItem("r7_formData");
    if(saved){
        const data = JSON.parse(saved);

        document.getElementById("tanggal").value = data.tanggal || "";
        document.getElementById("petugas").value = data.petugas || "";
        document.getElementById("driver").value = data.driver || "";
        document.getElementById("nopol").value = data.nopol || "";
        document.getElementById("angkutan").value = data.angkutan || "";
        document.getElementById("mode").value = data.mode || "";
    }
}

// Event listener auto save saat diketik
["petugas","driver","nopol","angkutan","mode"].forEach(id=>{
    document.getElementById(id).addEventListener("input", simpanFormR7);
});

// Simpan juga tanggal tiap update
setInterval(simpanFormR7, 1000);

// Load saat halaman dibuka
window.addEventListener("load", function(){
    loadFormR7();
});

// =============================
// OVERRIDE HAPUS SEMUA + RESET FORM
// =============================

(function(){

    const hapusAsli = hapusSemua;

    hapusSemua = function(){

        // Jalankan fungsi hapus asli
        hapusAsli();

        // Hapus data form dari localStorage
        localStorage.removeItem("r7_formData");

        // Reset semua field form
        document.getElementById("petugas").value = "";
        document.getElementById("driver").value = "";
        document.getElementById("nopol").value = "";
        document.getElementById("angkutan").value = "";
        document.getElementById("mode").value = "";

        // Update ulang tanggal otomatis
        updateTanggalJam();

        // Fokus kembali ke input petugas
        document.getElementById("petugas").focus();

        console.log("Semua data + form berhasil direset");
    };

})();

// ======================================
// OVERRIDE HAPUS SEMUA + KONFIRMASI
// ======================================

(function(){

    const hapusAsli = hapusSemua;

    hapusSemua = function(){

        // Popup konfirmasi
        let yakin = confirm(
            "‚ö†Ô∏è YAKIN MAU HAPUS SEMUA DATA?\n\n" +
            "Semua data kantong, berat, dan form akan direset dari awal!"
        );

        if(!yakin){
            return; // batal jika tekan Cancel
        }

        // Jalankan fungsi hapus asli (hapus tabel & scan)
        hapusAsli();

        // Hapus data form dari localStorage
        localStorage.removeItem("r7_formData");

        // Reset field form
        document.getElementById("petugas").value = "";
        document.getElementById("driver").value = "";
        document.getElementById("nopol").value = "";
        document.getElementById("angkutan").value = "";
        document.getElementById("mode").value = "";

        // Reset tanda tangan juga
        if(typeof clearSignature === "function"){
            clearSignature();
        }

        // Update tanggal otomatis
        updateTanggalJam();

        // Fokus kembali
        document.getElementById("petugas").focus();

        alert("‚úÖ Semua data berhasil dihapus dan direset.");
    };

})();

// // =============================
// REALTIME SYNC VERSI STABIL
// =============================

// FORMAT ROOM SELALU SAMA (YYYYMMDD)
function getRoomId(){
    const today = new Date();
    return "R7_" +
        today.getFullYear() +
        ("0"+(today.getMonth()+1)).slice(-2) +
        ("0"+today.getDate()).slice(-2);
}

// ROOT ROOM
const roomRoot = db.ref("R7_SYNC/" + getRoomId());
const roomDataRef = roomRoot.child("DATA");
const roomFormRef = roomRoot.child("FORM");


// =============================
// KIRIM DATA BARCODE
// =============================
function kirimKeFirebase(barcode, berat){

    roomDataRef.child(barcode).set({
        barcode: barcode,
        berat: berat,
        timestamp: Date.now()
    });
}


// =============================
// OVERRIDE prosesBarcode TANPA MERUSAK LOGIC LAMA
// =============================
(function(){

    const prosesAsli = prosesBarcode;

    prosesBarcode = function(barcode){

        let before = scannedBarcodes.length;

        prosesAsli(barcode);

        let after = scannedBarcodes.length;

        // Jika benar-benar bertambah
        if(after > before){
            let data = scannedData.find(d => d.barcode === barcode);
            if(data){
                kirimKeFirebase(barcode, data.berat);
            }
        }
    };

})();


// =============================
// TERIMA DATA DARI DEVICE LAIN
// =============================
roomDataRef.on("child_added", snapshot => {

    const data = snapshot.val();
    if(!data) return;

    if(!scannedBarcodes.includes(data.barcode)){

        scannedBarcodes.push(data.barcode);
        scannedData.push({
            barcode: data.barcode,
            berat: data.berat
        });

        tambahData(data.barcode, data.berat);
        updateScanCounter();
        updateTotalBerat();
        simpanLocal();

        showNotif("üì° Data Masuk dari Perangkat Lain","success");
    }
});


// =============================
// JIKA DATA DIHAPUS DEVICE LAIN
// =============================
roomDataRef.on("child_removed", snapshot => {

    const data = snapshot.val();
    if(!data) return;

    const barcode = data.barcode;

    // Hapus dari array
    scannedBarcodes = scannedBarcodes.filter(b => b !== barcode);
    scannedData = scannedData.filter(d => d.barcode !== barcode);

    // Cari row berdasarkan isi kolom kedua
    const rows = document.querySelectorAll("#tabelData tr");

    for(let i=1; i<rows.length; i++){
        const cellBarcode = rows[i].cells[1];

        if(cellBarcode && cellBarcode.textContent.trim() === barcode){
            rows[i].remove();
            break;
        }
    }

    updateNomor();
    updateScanCounter();
    updateTotalBerat();
    simpanLocal();

    showNotif("üì° Data Dihapus dari Perangkat Lain","error");
});


// =============================
// SYNC FORM REALTIME
// =============================
function kirimFormKeFirebase(){

    const formData = {
        petugas: document.getElementById("petugas").value,
        driver: document.getElementById("driver").value,
        nopol: document.getElementById("nopol").value,
        angkutan: document.getElementById("angkutan").value,
        mode: document.getElementById("mode").value
    };

    roomFormRef.set(formData);
}

// AUTO KIRIM SAAT DIKETIK
["petugas","driver","nopol","angkutan","mode"].forEach(id=>{
    document.getElementById(id).addEventListener("input", ()=>{
        kirimFormKeFirebase();
    });
});

// TERIMA UPDATE FORM DARI DEVICE LAIN
roomFormRef.on("value", snapshot => {

    const data = snapshot.val();
    if(!data) return;

    document.getElementById("petugas").value = data.petugas || "";
    document.getElementById("driver").value = data.driver || "";
    document.getElementById("nopol").value = data.nopol || "";
    document.getElementById("angkutan").value = data.angkutan || "";
    document.getElementById("mode").value = data.mode || "";
});


// =============================
// HAPUS SEMUA (VERSI STABIL)
// =============================
function hapusSemua(){

    let yakin = confirm(
        "‚ö†Ô∏è YAKIN MAU HAPUS SEMUA DATA?\n\n" +
        "Semua data kantong dan form akan direset!"
    );

    if(!yakin) return;

    // Hapus dari Firebase
    roomDataRef.remove();
    roomFormRef.remove();

    // Reset lokal
    scannedBarcodes = [];
    scannedData = [];

    document.getElementById("tabelData").innerHTML =
    `<tr>
        <th>No</th>
        <th>Kantong</th>
        <th>Berat (KG)</th>
        <th>Hapus</th>
    </tr>`;

    updateScanCounter();
    updateTotalBerat();

    localStorage.removeItem("r7_scannedBarcodes");
    localStorage.removeItem("r7_scannedData");
    localStorage.removeItem("r7_formData");

    document.getElementById("petugas").value="";
    document.getElementById("driver").value="";
    document.getElementById("nopol").value="";
    document.getElementById("angkutan").value="";
    document.getElementById("mode").value="";

    if(typeof clearSignature === "function"){
        clearSignature();
    }

    alert("‚úÖ Semua data berhasil direset.");
}
</script>
</body>
</html>
